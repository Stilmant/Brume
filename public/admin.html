<!doctype html>
<html>
<head>
  <meta charset='utf-8'/>
  <title>Brume - Administration</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #1e1e1e;
      color: #e4e4e7;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      background: #252525;
      padding: 12px 20px;
      border-bottom: 1px solid #3f3f46;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #e4e4e7;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(90deg, #667eea 0%, #aee2ff 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(118,75,162,0.10);
      overflow: hidden;
      margin: 0 8px 0 0;
    }
    .logo img {
      width: 28px;
      height: 28px;
      display: block;
      margin: auto;
    }
    .admin-badge {
      background: #dc2626;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .main-container { display: flex; flex: 1; overflow: hidden; }
    #left {
      width: 320px;
      background: #252525;
      border-right: 1px solid #3f3f46;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #3f3f46;
      background: #2a2a2a;
    }
    .sidebar-header h3 {
      font-size: 14px;
      font-weight: 600;
      color: #a1a1aa;
      text-transform: uppercase;
    }
    #list { flex: 1; overflow-y: auto; padding: 8px; }
    #list::-webkit-scrollbar { width: 8px; }
    #list::-webkit-scrollbar-track { background: #252525; }
    #list::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    .session-item {
      padding: 12px;
      margin: 4px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      border: 1px solid transparent;
    }
    .session-item:hover { background: #2a2a2a; border-color: #3f3f46; }
    .session-item.active { background: #3f3f46; border-color: #667eea; }
    .session-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .session-id {
      font-size: 13px;
      font-weight: 600;
      color: #e4e4e7;
      font-family: 'Courier New', monospace;
    }
    .badge {
      background: #dc2626;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }
    .session-info { font-size: 12px; color: #a1a1aa; }
    #right { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; }
    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid #3f3f46;
      background: #252525;
    }
    .chat-header h2 { font-size: 16px; font-weight: 600; color: #e4e4e7; }
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #71717a;
      font-size: 15px;
      text-align: center;
      padding: 40px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #chat::-webkit-scrollbar { width: 8px; }
    #chat::-webkit-scrollbar-track { background: #1e1e1e; }
    #chat::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    .message { display: flex; gap: 12px; max-width: 800px; }
    .message.user { align-self: flex-start; }
    .message.admin { align-self: flex-end; }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-weight: 600;
      font-size: 13px;
    }
    .avatar.user { background: #3b82f6; color: white; }
    .avatar.admin {
      background: linear-gradient(90deg, #667eea 0%, #aee2ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      overflow: hidden;
    }
    .avatar.admin img {
      width: 24px;
      height: 24px;
      display: block;
      margin: auto;
    }
    .message-bubble {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 500px;
      line-height: 1.5;
      font-size: 14px;
    }
    .message.user .message-bubble {
      background: #3f3f46;
      color: #e4e4e7;
      border-top-left-radius: 4px;
    }
    .message.admin .message-bubble {
      background: #667eea;
      color: white;
      border-top-right-radius: 4px;
    }
    #send {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-top: 1px solid #3f3f46;
      background: #252525;
      gap: 12px;
    }
    #msg {
      flex: 1;
      background: #3f3f46;
      border: 1px solid #52525b;
      padding: 12px 16px;
      border-radius: 8px;
      color: #e4e4e7;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      resize: none;
      max-height: 120px;
    }
    #msg:focus { border-color: #667eea; }
    #msg::placeholder { color: #71717a; }
    #btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.2s;
    }
    #btn:hover { background: #5a67d8; }
    #btn:disabled { background: #3f3f46; color: #71717a; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class='header'>
    <h1><span class='logo'><img src="brume-thought.svg" alt="Brume" /></span>Brume</h1>
    <span class='admin-badge'>Admin</span>
  </div>
  <div class='main-container'>
    <div id='left'>
      <div class='sidebar-header'><h3>Sessions Utilisateurs</h3></div>
      <div id='list'></div>
    </div>
    <div id='right'>
      <div class='chat-header' id='chatHeader'><h2>SÃ©lectionnez une session</h2></div>
      <div id='chat'>
        <div class='empty-state'><div><p>ðŸ‘ˆ SÃ©lectionnez une session</p><p style='margin-top:8px;font-size:13px;'>pour voir la conversation</p></div></div>
      </div>
      <div id='send' style='display:none;'>
        <input id='msg' placeholder='Tapez votre rÃ©ponse en tant que Brume...'/>
        <button id='btn'>Envoyer</button>
      </div>
    </div>
  </div>
  <script src='/socket.io/socket.io.js'></script>
  <script>
    const socket=io({query:{role:'admin'}});
    const list=document.getElementById('list');
    const chat=document.getElementById('chat');
    const chatHeader=document.getElementById('chatHeader');
    const msg=document.getElementById('msg');
    const btn=document.getElementById('btn');
    const sendDiv=document.getElementById('send');
    let currentId=null;
    let sessions=[];
    function renderList(items){
      sessions=items;
      list.innerHTML='';
      if(items.length===0){
        list.innerHTML='<div style=\"padding:20px;text-align:center;color:#71717a;\">En attente...</div>';
        return;
      }
      items.forEach(it=>{
        const row=document.createElement('div');
        row.className='session-item'+(currentId===it.id?' active':'');
        const header=document.createElement('div');
        header.className='session-header';
        const idSpan=document.createElement('span');
        idSpan.className='session-id';
        idSpan.textContent=it.id;
        const badgeContainer=document.createElement('div');
        if(it.unread){
          const badge=document.createElement('span');
          badge.className='badge';
          badge.textContent='NEW';
          badgeContainer.appendChild(badge);
        }
        header.appendChild(idSpan);
        header.appendChild(badgeContainer);
        const info=document.createElement('div');
        info.className='session-info';
        info.textContent=it.messages+' message'+(it.messages>1?'s':'');
        row.appendChild(header);
        row.appendChild(info);
        row.onclick=()=>{
          currentId=it.id;
          chatHeader.querySelector('h2').textContent='Conversation: '+it.id;
          chat.innerHTML='';
          sendDiv.style.display='flex';
          socket.emit('join_session',it.id);
          renderList(sessions);
        };
        list.appendChild(row);
      });
    }
    function addBubble(cls, text){
      const messageDiv=document.createElement('div');
      messageDiv.className='message '+cls;
      let avatar;
      if(cls==='admin'){
        avatar=document.createElement('div');
        avatar.className='avatar admin';
        avatar.innerHTML='<img src="brume-thought.svg" alt="Brume" />';
      }else if(cls==='user'){
        avatar=document.createElement('div');
        avatar.className='avatar user';
        avatar.textContent='U';
      }else{
        avatar=document.createElement('div');
        avatar.className='avatar '+cls;
        avatar.textContent='?';
      }
      const bubble=document.createElement('div');
      bubble.className='message-bubble';
      bubble.textContent=text;
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      chat.appendChild(messageDiv);
      chat.scrollTop=chat.scrollHeight;
    }
    socket.on('session_list',renderList);
    socket.on('history',({id,messages})=>{
      chat.innerHTML='';
      if(messages.length===0){
        chat.innerHTML='<div class=\"empty-state\">Aucun message</div>';
      }else{
        messages.forEach(m=>addBubble(m.from==='user'?'user':'admin',m.text));
      }
    });
    socket.on('admin_echo',({text})=>addBubble('admin',text));
    btn.onclick=()=>{
      const t=msg.value.trim();
      if(!t||!currentId)return;
      socket.emit('answer',{id:currentId,text:t});
      msg.value='';
      msg.style.height='auto';
    };
    msg.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){
        e.preventDefault();
        btn.click();
      }
    });
    msg.addEventListener('input',function(){
      this.style.height='auto';
      this.style.height=this.scrollHeight+'px';
    });
  </script>
</body>
</html>
